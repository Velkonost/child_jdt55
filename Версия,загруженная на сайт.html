<!DOCTYPE html>
<html> 
	<head> 
	<script src="https://code.jquery.com/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
	<script src="/sites/jdt55/files/users/Calc_files/tarifs_for_calculator.js.txt"></script>
	<link href="/sites/jdt55/files/users/Calc_files/style_for_calculator_klim.css" rel="stylesheet">
	<link rel='stylesheet' href='/sites/jdt55/files/users/Calc_files/bootstrap.min.css' type='text/css'>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Калькулятор грузоперевозок</title> 
	</head> 
<body> 
<div class="layer1">
		<h2>Цены на доставку груза:</h2>
			<p style="font-size: 12px"><a href="/sites/jdt55/files/users/admin1/prais-list_no1_zhd_perevozki.doc"><span style="color: rgb(102, 153, 102);">Расценки (тарифы) на ЖД доставку сборных грузов</span></a></p>

			<p style="font-size: 12px"><a href="/sites/jdt55/files/users/admin3/prays-list_no2_avtoperevozki.xls"><span style="color: rgb(102, 153, 102);">Расценки (тарифы) на автоперевозки сборных грузов</span></a></p>

			<p style="font-size: 12px"><a href="/sites/jdt55/files/users/admin3/prays-list_no4_avtoekspedirovanie_po_moskve_i_oblasti.doc">Расценки (тарифы) на услуги автоэкспедирования грузов по г. Москва</a></p>

			<p style="font-size: 12px"><a href="/sites/jdt55/files/users/admin3/prays-list_no3_avtoekspedirovanie_po_omsku.doc">Расценки (тарифы) на услуги автоэкспедирования грузов по г. Омску</a></p>

			<p style="font-size: 12px"><a href="/sites/jdt55/files/users/admin3/prays-list_no5_dop.upakovku_gruzov_v_g.moskva_0.doc"><span style="color: rgb(102, 153, 102);">Расценки (тарифы) на услуги дополнительной упаковки грузов в г. Москва</span></a></p>

			<p style="font-size: 12px"><a href="/sites/jdt55/files/users/admin3/prays_spb-omsk-spb.xls">Расценки (тарифы) на автоперевозку грузов Санкт-Петербург-Омск</a></p>

			<p style="font-size: 12px"><a href="/sites/jdt55/files/users/admin3/prays-list_no6_avtoekspedirovanie_po_novosibirsku.xls">Расценки (тарифы) на услуги автоэкспедирования грузов по г. Новосибирск</a></p>

			<p style="font-size: 12px"><a href="/sites/jdt55/files/users/admin3/prays-list_avto-_refrizherator_iz_moskvy_v_omsk.doc">Расценки (тарифы) на перевозку автомобилем-рефрижератором в г.Омск</a><span style="color:#ff0000;">&nbsp;</span></p>

			<p style="font-size: 12px"><a href="/sites/jdt55/files/users/admin3/%D0%BF%D1%80%D0%B0%D0%B9%D1%81%20%D0%BD%D1%81%D0%BA-%D0%BE%D0%BC%D1%81%D0%BA.xls">Расценки (тарифы) на автоперевозки сборных грузов из Новосибирска</a></p>

			<p style="font-size: 12px"><a href="/sites/jdt55/files/users/admin3/prays_iz_omska_i_pavlodara_3.xls">Расценки (тарифы) из Омска в Казахстан и из Павлодара в Россию</a></p>

			<p style="font-size: 12px"><a href="/sites/jdt55/files/users/admin3/prays_iz_msk_nvs_v_kazahstan_3.xls">Расценки (тарифы) из Москвы, Новосибирска в Казахстан</a></p>

			<p style="font-size: 12px"><a href="/sites/jdt55/files/users/admin3/prays_iz_spb_v_kazahstan_3.xls">Расценки (тарифы) из Санкт-Петербурга в Казахстан</a></p>
			<p style="font-size: 12px"><a href="/sites/jdt55/files/users/admin3/prays_iz_ekb_i_tyumeni.xls">Расценки (тарифы) из Екатеринбурга и Тюмени в Казахстан</a></p>
			<p>&nbsp;</p>
</div>
<div class="calc">
<form name="calc"> 
<h2>Предварительный расчет</h2>
	<div class="cities">
		<div align="left" class="selector">
			<select name="from" id="artkli-from" class="form-control ff" onchange="artkli.fill_text();artkli.update_where();artkli.update_from();">
				<option selected disabled value="undefined_city">Город отправления</option>
			</select>
		</div>
		<div align="left" class="selector" id="artkli-where">
			<select name="where" id="artkli-where_select" class="form-control" onchange="artkli.fill_text();artkli.update_from();artkli.update_where()">
				<option selected disabled value="undefined_city">Город назначения</option>
			</select>
		</div>
		<div class="artkli-custom-button input" align="right">
			<button type="button" class="btn btn-primary" onclick="artkli.reset()">Сброс</button>
		</div>
	</div>
	
	<div class="main" align="left">
		<div id="artkli-choose_way" class="input">
			<font size="3">	Способ доставки: </font> 
			<input type="radio" id="artkli-jd" name="way" onchange="artkli.fill_text();" checked value=1><font size="3"> ЖД </font></input>
			<input type="radio" id="artkli-auto" name="way" onchange="artkli.fill_text();" value=2><font size="3"> АВТО </font></input>
		</div>
		<br/>
		<div class="artkli-custom-input input" align="left">		
			<font size="4">Вес - </font>
			<input id="artkli-massa" name= "massa" type="number" min="0" placeholder = "Кг" value="" onchange="artkli.fill_text();" maxlength="8" size="20"/>
		</div>
		<div class="artkli-custom-input input" align="left">
			<font size="4">&nbsp;&nbsp;Объем - </font>
			<input id="artkli-volume" name= "volume" type="number" min="0" placeholder = "Куб.м." value="" onchange="artkli.fill_text()" maxlength="8" size="20">
		</div>
		
		<font size="3"><span class="artkli-custom-input span" id = "artkli-result">Итог</span></font>					
	</form>
</div>
	<br>
	<div class="artkli-footer" align="right">
		<p style="font-size: 10px">	Калькулятор разработан при поддержке <a href="http://www.progschool.ru"><img src="http://www.progschool.ru/favicon.ico" style="vertical-align:-3px;width:16px;height:16px;margin-right:1px">Школы программиста</a>.</p>
		<p style="font-size: 10px">	Наставник: <a href="http://chivorotkiv.livejournal.com/">Сергей Шмаков</a></p>
	</div>
</div>
	<script>
(function() {
	function update_way_dependent(tarifs, from, to) { 
			var dependency = document.getElementById('artkli-choose_way'); 
			if(!tarifs || to == "undefined_city" || from == "undefined_city"){
				dependency.setAttribute('class', 'artkli-hidden'); 
			}
			else{
				if(Object.keys(artkli_tarifs[from][to]).length == 2){
					dependency.setAttribute('class', ''); 
				}
				else{
					dependency.setAttribute('class', 'artkli-hidden'); 
				}
			}
	} 
	function get_tarifs(){return artkli_tarifs;}
	function get_from_cities(tarifs){
		var all_from = Object.keys(tarifs);
		var wrapper = all_from;
		var nodes = wrapper;
		var len = nodes.length;
		var sorted = [];
		while (nodes[0]) {
		//	console.log(nodes[0]);
			var city = artkli_city_names[nodes[0]];
				sorted.push(new String(city));
				sorted[sorted.length-1].element = nodes[0];
				wrapper.splice(0,1);
		}
		sorted = sorted.sort();
		for (var i = 0; i < len; i++) {
			wrapper[i] = sorted[i].element;
		}
		all_from = wrapper;
		return all_from;
	 }
	function get_where_cities(tarifs){
		var all_from = Object.keys(tarifs);
		var arr = [];
		var i = 0;
		for(var i = 0; i < all_from.length; i++){
			var from_city = tarifs[all_from[i]];
			var from_city = Object.keys(from_city);
			arr[arr.length] = from_city;
		}
		var where_cities = arr[3], compare;
		for(i = 0; i < arr.length; i++){
			for(var j = 0; j < arr[i].length; j++){
				var checker = arr[i];
				var checker = checker[j];
				for(var k = 0; k < where_cities.length; k++){
					compare = -1;
					if(checker == where_cities[k]){
						c = 1;
						where_cities.splice(k,k+1);
					}
				}
				if(compare == -1){
					where_cities[where_cities.length] = checker;
				}
			}
		}

		var wrapper = where_cities;
		var nodes = wrapper;
		var len = nodes.length;
		var sorted = [];
		while (nodes[0]) {
			var city = artkli_city_names[nodes[0]];
				sorted.push(new String(city));
				sorted[sorted.length-1].element = nodes[0];
				wrapper.splice(0,1);
		}
		sorted = sorted.sort();
		for (var i = 0; i < len; i++) {
			wrapper[i] = sorted[i].element;
		}
		where_cities = wrapper;
		return where_cities;
	}
	function conclusion_tax(tarifs, from, where, mass, volume, way){
		var from_tarifs = tarifs[from];
		var ways = from_tarifs && from_tarifs[where];
		var ranges = ways && (ways[way] || ways.default_way);
		if(!ranges){
			return {by_mass: NaN, by_volume: NaN}
		}
		return{
				by_mass: get_tax(ranges.mass_range, ranges.mass_price, mass),
				by_volume: get_tax(ranges.volume_range, ranges.volume_price, volume)
		}
	}
	function get_tax(valueRange, taxRange, tax){
		var gradation = valueRange;
		var amount = gradation.length;
		var end = 0;
		var i;
		for(i = amount; i >= 0; i--){
			if(tax < gradation[i]){
				end = taxRange[i];	
			}
		}
		if(end == 0){
			var amount = taxRange.length
			end = taxRange[amount-1];
		}
		return end;
	}
	function what_is_way(){
		var way = document.getElementsByName('way');
		if(way[0].checked){
			var way = "jd_way";
		}
		else{
			var way = "auto_way";
		}
		return way;
	}


	function build_option_html(city, city_name){
		return "<option value=\"" + city + "\">" + city_name + "</option>";
	} 
	function build_option_html_selected(city, city_name){
		return "<option selected value=\"" + city + "\">" + city_name + "</option>";
	}
	function build_first_option(){
		return	"<option selected disabled value=\"undefined_city\">Выберите город</option>";
	}



	function get_where_cities_by_from(from, tarifs){
		var cities = {};
		var all_from = get_from_cities(tarifs);
		var all_where = get_where_cities(tarifs);
		if(from == "undefined_city"){
			from = null;
		}
		if(!from){
			for(var i = 0; i < all_where.length; i++){
				cities[all_where[i]] = true;
			}
		}
		else{
			var concrete_where = tarifs[from];
			var concrete_where = Object.keys(concrete_where);
			for(var i = 0; i < all_where.length; i++){
				var city_check = all_where[i];
				for(var j = 0; j < concrete_where.length; j++){
					if(city_check == concrete_where[j]){
						cities[city_check] = true;
						break;
					}
					else{
						cities[city_check] = false;
					}
				}
			}
		}
		return cities;
	}
	function get_from_cities_by_where(where, all_from, tarifs){
		var all_from = get_from_cities(artkli_tarifs);
		var cities = {};
		if(where == "undefined_city"){
			where = null;
		}
		if(!where){
			for(var i = 0; i < all_from.length; i++){
				cities[all_from[i]] = true;
			}
		}
		else{
			var from_cities = [];
			for(var i = 0; i < all_from.length; i++){
				var from = all_from[i];
				var from = Object.keys(tarifs[from]);
				for(var j = 0;j < from.length; j++){
					if(from[j] == where){
						from_cities[from_cities.length] = all_from[i];
						break;
					}
				}
			}
			for(var i = 0; i < all_from.length; i++){
				var city_check = all_from[i];
				for(var j = 0; j < from_cities.length; j++){
					if(city_check == from_cities[j]){
						cities[city_check] = true;
						break;
					}
					else{
						cities[city_check] = false;
					}
				}
			}
		}
		return cities;
	}
	function selector_update(cities_n, options, sel_city, cities){
		for(var i = 0; i < cities.length; i++) {
			var city = cities[i];
			if(cities_n[city] == true){
				if(city == sel_city){
					var option = build_option_html_selected(city, artkli_city_names[city]);
				}
				else{
				var option = build_option_html(city, artkli_city_names[city]);
				}
				options.push(option);
			}
		}
		var options_html = options.join("\n");
		return options_html;
	}
	
	function update_where_selector(tarifs, city_names, from, where_select) {
		var sel_where = where_select.value;
		var where_cities_n = get_where_cities_by_from(from, tarifs);
		var where_cities = Object.keys(where_cities_n);
		var options = [];
		var options_html = selector_update(where_cities_n, options, sel_where, where_cities);
		where_select.innerHTML = options_html;
	}
	function update_from_selector(tarifs, city_names, from_select, where){	
		var sel_from = from_select.value;
		var all_from = get_from_cities(tarifs);
		var from_cities_n = get_from_cities_by_where(where, all_from, tarifs);
		var from_cities = Object.keys(from_cities_n);
		var options = [];
		var options_html = selector_update(from_cities_n, options, sel_from, from_cities);

		from_select.innerHTML = options_html;
	}
	function update_where(){
		var from_block = document.getElementsByName('from'); 
		var where_block = document.getElementsByName('where');

		var from_elem = from_block[0]; 
		var where_elem = where_block[0];

		var from = from_elem.value; 
		var where = where_elem.value;

		update_where_selector(artkli_tarifs, artkli_city_names, from, where_elem);
	}
	function update_from(){
		var from_block = document.getElementsByName('from'); 
		var where_block = document.getElementsByName('where');

		var from_elem = from_block[0]; 
		var where_elem = where_block[0];

		var from = from_elem.value; 
		var where = where_elem.value;

		update_from_selector(artkli_tarifs, artkli_city_names, from_elem, where);
	}
	function initialization(){
		var by_from = get_where_cities_by_from(null, artkli_tarifs);
		var by_where = get_from_cities_by_where(null, get_from_cities(artkli_tarifs), artkli_tarifs);
		var from_block = document.getElementsByName('from'); 
		var where_block = document.getElementsByName('where');

		var from_elem = from_block[0]; 
		var where_elem = where_block[0];

		update_way_dependent(); 

		var all_from = get_from_cities(artkli_tarifs);
		var from_cities = all_from;
		var options = [];
		var f_option = build_first_option();
		options.push(f_option);
		for(var i = 0; i < from_cities.length; i++){
			var city = from_cities[i];
				var option = build_option_html(city, artkli_city_names[city]);
				options.push(option);		
		}
		var options_html = options.join("\n");
		var from_select = document.getElementById('artkli-from');
		from_select.innerHTML = options_html;
		

		var where_cities = get_where_cities(artkli_tarifs);
		var from_select = document.getElementById('artkli-where_select');
		var options = [];
		var f_option = build_first_option();
		options.push(f_option);
		for(var i = 0; i < where_cities.length; i++) {
			var city = where_cities[i];
				var option = build_option_html(city, artkli_city_names[city]);
				options.push(option);
		}
		var options_html = options.join("\n");
		var where_select = document.getElementById('artkli-where_select');
		where_select.innerHTML = options_html;
	}
function digit(result){
	return result.replace(/(\d{1,3}(?=(\d{3})+(?:\.\d|\b)))/g,"\$1 ");
}


function reset(){
		var from_block = document.getElementsByName('from'); 
		var where_block = document.getElementsByName('where');
		var massa_block = document.getElementsByName('massa');
		var volume_block = document.getElementsByName('volume');

		update_way_dependent(); 

		var from_elem = from_block[0]; 
		var where_elem = where_block[0];
		var mass = massa_block[0];
		var volume = volume_block[0]; 

		mass.value = "";
		volume.value = "";

		var from = from_elem.value; 
		var where = where_elem.value;

		var resultat = "";
		document.getElementById('artkli-result').innerHTML = resultat;

		var all_from = get_from_cities(artkli_tarifs);
		var from_cities = all_from;
		var options = [];
		var f_option = build_first_option();
		options.push(f_option);
		for(var i = 0; i < from_cities.length; i++){
			var city = from_cities[i];
				var option = build_option_html(city, artkli_city_names[city]);
				options.push(option);		
		}
		var options_html = options.join("\n");
		var from_select = document.getElementById('artkli-from');
		from_select.innerHTML = options_html;
		

		var where_cities = get_where_cities(artkli_tarifs);
		var from_select = document.getElementById('artkli-where_select');
		var options = [];
		var f_option = build_first_option();
		options.push(f_option);
		for(var i = 0; i < where_cities.length; i++) {
			var city = where_cities[i];
				var option = build_option_html(city, artkli_city_names[city]);
				options.push(option);
		}
		var options_html = options.join("\n");
		var where_select = document.getElementById('artkli-where_select');
		where_select.innerHTML = options_html;
	}
	initialization();





	function fill_text(){    			//ОСНОВНАЯ ФУНКЦИЯ
		var tax_by_mass = 0;
		var tax_by_volume = 0;
			
		var from_select = document.getElementsByName('from'); 
		var massa_block = document.getElementsByName('massa'); 
		var where_select = document.getElementsByName('where');
		var volume_block = document.getElementsByName('volume');

		var way = what_is_way();

		var several_ways = [
			"piteromsk" ,
		];
		var only_auto_way = [
			"omskpiter"	
		];

		var resultat;

		var from_elem = from_select[0]; 
		var where_elem = where_select[0];
		var mass = massa_block[0];
		var volume = volume_block[0]; 
		var ch_elem = from_select[0];
		var from = from_elem.value; 
		var where = where_elem.value;

		var check_auto = from + where;

		update_way_dependent(artkli_tarifs, from, where); 

		var tarifs = get_tarifs();

		if(mass.value == 0){					
			resultat = "Введите массу груза!";
		}
		else if(volume.value == 0){
			resultat = "Введите объем груза!";
		}
		else{
				var tax = conclusion_tax(artkli_tarifs, from, where, mass.value, volume.value, way);
				var tax_by_mass = tax.by_mass;
				var tax_by_volume = tax.by_volume;

				var ans1 = tax_by_mass * mass.value; // ВЫЧИСЛЕНИЕ СТОИМОСТИ ПО ВЕСУ
				var ans2 = tax_by_volume * volume.value; // ВЫЧИСЛЕНИЕ СТОИМОСТИ ПО ОБЪЕМУ

				if(ans1 > ans2){
					resultat = ans1;
				}
				else{
					resultat = ans2;
				}
				if(only_auto_way.indexOf(check_auto) != -1){
					if( mass.value > 5000 || volume.value >  25){
						resultat = "Цена договорная";
					}
					else{
					resultat = Math.round(resultat);
					resultat = String(resultat);
					resultat = digit(resultat);
					resultat = "Автоперевозка! Итоговая сумма - "+resultat+" руб."; 
					}
				}
				else if(isNaN(resultat)){
					resultat = " ";
				}
				else if(tax_by_volume == -2 || tax_by_mass == -2){
					resultat = "Цена договорная";
				}
				else{
					resultat = Math.round(resultat);
					resultat = String(resultat);
					resultat = digit(resultat);
					resultat = "Итоговая сумма - "+ resultat +" руб.";
				}
			}

		document.getElementById('artkli-result').innerHTML = resultat;
	}
	window.artkli = {
		update_where: update_where,
		fill_text: fill_text,
		update_where: update_where,
		update_from: update_from,
		reset: reset
	};
})();
	</script>
</body>
</html>






